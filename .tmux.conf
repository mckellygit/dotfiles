#
# byobu w/tmux config
#
unbind-key -n C-a
unbind-key -n C-s
set -g prefix ^S
set -g prefix2 None
bind s send-prefix

#if-shell '[[ $TERM =~ "-16color" ]]'  'set -g default-terminal screen-16color'
#if-shell '[[ $TERM =~ "-256color" ]]' 'set -g default-terminal tmux-256color'
# use tmux-256color instead of screen-256color as has modified func keys
set -g default-terminal "tmux-256color"
set -g default-command "/usr/bin/zsh"
set-window-option -g mode-keys vi
set -g base-index 1
setw -g pane-base-index 1

# dont wrap search around other end of scrollback buffer
set -g wrap-search off

bind-key -T prefix k confirm-before -p "kill-pane #P? (y/n)" kill-pane

# this was backslash, change to S
bind-key -T prefix S confirm-before kill-server
# need space after backslash here or put it in single quotes
unbind-key -T prefix '\'

# approx scroll back limit
set -g history-limit 10000

set -g status-keys vi

# message display time (ms)
set -g display-time 371

set -g mouse on

#setw -g alternate-screen on

setw -g monitor-bell off

# Look into for terminals that support these
# Esc sequences for sending over ssh etc. ...
# could be on | external | off
set -g set-clipboard off

# update interval
set -g status-interval 10

# if focus events supported
set -g focus-events on

# default is " -_@"
# (different than vim due to vim c/c++ devel)
set -g word-separators " ='`;:+|[](){},/?\\\""

# Set window title string
#  #H  Hostname of local host
#  #I  Current window index
#  #P  Current pane index
#  #S  Session name
#  #T  Current window title
#  #W  Current window name
#  #   A literal â€˜#â€™
set-window-option -g automatic-rename on
# sets window name to format below ...
#set-option -g automatic-rename-format '#{=-12:pane_current_path}'
# if shell PROMPT/PS1/etc. sets title (can work over ssh) ...
set-option -g automatic-rename-format '#{pane_title}'
# but we may change title in app to comm with tmux ...
set-option -g allow-rename on

# terminal window title
set-option -g set-titles on
# shell PROMPT/PS1/etc. can change title dynamically ...
#set-option -g set-titles-string '#{pane_title}'
# but we may change title in app to comm with tmux ...
# #I:#W makes title match win/tab names ...
#set-option -g set-titles-string '#I:#W'
set-option -g set-titles-string 'tmux:#{client_termname}'

# auto renumber windows on close
setw -g renumber-windows on

set-window-option -g extended-keys on

# NOTE: unset to remove any previous (byobu) overrides
#       (byobu also maps M-L/R/U/D)
set-option -g terminal-overrides ''
# NOTE: use -ga here to add instead of overwrite ...
# NOTE: smcup/rmcup setting breaks kitty scrollwheel ...
#set-option -ga terminal-overrides 'xterm*:smcup@:rmcup@'
#set-option -ga terminal-overrides ',*:Ss=\E[%p1%d q:Se=\E[2 q'
#set-option -ga terminal-overrides ',*256col*:RGB:sitm=\E[3m'

# ==============================================

# byobu settings:

# these colors are hard-coded -
# BYOBU_ACCENT=#75507B
# BYOBU_DARK=#333333
# BYOBU_HIGHLIGHT=#DD4814
# BYOBU_LIGHT=#EEEEEE
# but these env vars are used below -
# BYOBU_RUN_DIR=/dev/shm/<tmp-path>
# BYOBU_CONFIG_DIR=/home/kellma02/.byobu

# make sure to check/unbind F1-F12 in terminator/parent terminal program
# so S-F12 func key toggle does not also unmap C-Right, etc.
bind -n F1 new-window -k -n config byobu-config
# remove byobu rename to "-"
bind -n F2 new-window -c "#{pane_current_path}"
# prefix C-c and prefix c also start new window in curr dir
bind -n F3 previous-window
bind -n F4 next-window
bind -n F5 source-file /usr/share/byobu/profiles/tmuxrc
bind -n F6 detach-client
bind -n F7 copy-mode
bind -n F8 command-prompt -p "(rename-window) " "rename-window '%%'"
bind -n F9 new-window -k -n config byobu-config
# F10 ?
# F11 often used in terminator for full-screen

bind-key -n S-F12 source $BYOBU_CONFIG_DIR/funckeys-disable.tmux \; display-message "Func-keys: DISABLED"

# add C-s C-r to update IP etc ...
bind-key -T prefix C-r source-file $BYOBU_PREFIX/share/byobu/profiles/tmuxrc \; refresh-client \; display-message "sourcing tmuxrc ..."

# ==============================================

#set -g status-bg colour239
set -g status-style "bg=colour239"

# non-active windows are slightly lighter ...
# but doing this loses default window transparency ...
#set -g window-style        "fg=default,bg=colour237"
#set -g window-active-style "fg=default,bg=colour236"
# setting fg only seems to work ...
set -g window-style        "fg=colour246"
set -g window-active-style "fg=#ffd1b7"
#set -g window-active-style "fg=colour252"

set -g window-status-style "fg=#EEEEEE,bg=#333333"
# current status background
set -g window-status-current-style "fg=#EEEEEE,bg=#804000"
#set -g window-status-current-style "reverse,fg=#EEEEEE,bg=#333333"
set -g window-status-activity-style "bold,fg=#EEEEEE,bg=#333333"

set -g pane-border-style "fg=#75507B,bg=default"
#set-option -g pane-active-border-style "fg=#DD4814,bg=#DD4814"

# to make border thin set its bg to default
set -g pane-active-border-style "bg=default"

# previous colour172 == orange, 102 is an ok grey
#set -g mode-style "fg=black,bg=colour172"
#set -g mode-style "fg=white,bg=colour131"
# 60, 66, 101, 102, 136, 144, 179, 214 ok as highlight
set -g mode-style "bg=black,fg=colour136"
#set -g mode-style "fg=black,bg=#BC6350"
#set -g mode-style "fg=#EEEEEE,bg=#75507B"

# previous colour3 == yellow
set -g message-style "fg=black,bg=colour131"
set -g message-command-style "fg=black,bg=colour131"

# -----------

# to change status bar color in copy-mode
set-hook -g 'pane-mode-changed'      'set -gF status-left-style "fg=#{?#{==:#{pane_mode},copy-mode},colour136,black},bg=#{?#{==:#{pane_mode},copy-mode},black,colour239}"'
set-hook -g 'session-window-changed' 'set -gF status-left-style "fg=#{?#{==:#{pane_mode},copy-mode},colour136,black},bg=#{?#{==:#{pane_mode},copy-mode},black,colour239}"'

# -----------

# move window tabs around
bind-key -T prefix < swap-window -t -1 \; prev
bind-key -T prefix > swap-window -t +1 \; next

# -----------

# vert split  - meaning a vert  cut ... (opposite of tmux but same as vi)
bind-key -T prefix '_' split-window -v -c "#{pane_current_path}"
# horiz split - meaning a horiz cut ... (opposite of tmux but same as vi)
bind-key -T prefix '|' split-window -h -c "#{pane_current_path}"

# use M-S- Left, Right, Up, Down to resize panes (A-S-U/D/L/R or Alt-Shift)

# -----------

# synchronize panes
bind-key -T prefix G set -w synchronize-panes \; display-message "synchronize-panes: #{?pane_synchronized,ON,OFF}"

# -----------

#   if-shell -Ft= '#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}'
#   (true if any application mouse flag is set, or if the pane is in a mode and it is not copy or view mode)
#   if-shell -Ft= '#{||:#{alternate_on},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}'
#   if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}'

# -----------

# quick help popup for some bindings etc ...
bind-key -T prefix h display-popup -K -E -R "\\cat ${BYOBU_CONFIG_DIR}/help.tmux | less -R -K -Q"
bind-key -T prefix g display-popup -h 5 -K -E -R "pcmd=\"#{pane_current_command}\" ; if [ \"\${pcmd####*ssh*}\" ] ; then ginfo=\$(gitinfo '#{pane_current_path}'); else ginfo=\"git:<n/a>\" ; fi ; echo \${ginfo} | less -R -K -Q -P:"

# -----------

# for repeat Left/Right
set -g repeat-time 1000

# this is a -s option now ...
set -s escape-time 10

# double/triple click period
#set -g click-time 220

# -----------

# unbind byobu mappings for these
# (byobu also sets terminal-overrides)

unbind -T root M-Up
unbind -T root M-Down
unbind -T root M-Right
unbind -T root M-Left

# if not #{alternate_on} dont send M-<arrow> key
# data to prevent extraneous chars in output
# TODO: do we need to send as an Esc-sequence ?
bind -T root M-Left \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'send-keys -l [1\\;3D'"

bind -T root M-Right \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'send-keys -l [1\\;3C'"

# NOTE: M-Up   available ...
# NOTE: M-Down available ...

bind -T root M-Up \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'send-keys -l [1\\;3A'"

bind -T root M-Down \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'send-keys -l [1\\;3B'"

# also these
bind -T root C-S-Home \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'send-keys C-S-Home'"

bind -T root C-S-End \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'send-keys C-S-End'"

bind -T root S-Home \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'send-keys S-Home'"

bind -T root S-End \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'send-keys S-End'"

bind -T root S-PPage \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'send-keys S-PPage'"

bind -T root S-NPage \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'send-keys S-NPage'"

# -----------

# move around panes

# next ------

# existing mappings:
#bind-key -T prefix C-Space next-window
#bind-key -T prefix Space   next-window
#bind-key -T prefix C-n     next-window
#bind-key -T prefix n       next-window
#bind-key -T prefix M-n     next-window -a

unbind -T prefix C-Space

# prefix-C-p is used for display-panes so unbind C-n as well ...
unbind-key -T prefix C-n

# prefix-M-p may be used for copyq popup so unbind M-n as well ...
unbind-key -T prefix M-n

# C-Right used in vim for next word
# M-Right used in vim for next tab

#bind-key -r -T prefix Right next
#bind-key -r -T prefix C-Right next
bind-key -T prefix Right   select-pane -R
bind-key -T prefix C-Right select-pane -R
# Super-Right (used by unity/terminator ?)
# S-Right used by tmux to traverse panes - changed above
# used now to nav windows ...
bind-key -T root S-Right next
# C-M-Right does not seem to work in tmux

# overloading C-Right is too confusing
#bind -T root C-Right \
#	if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
#		"if-shell -Ft= '#{alternate_on}' \
#			'send-keys C-Right' \
#			'next'"

# if we map C-^ to C-\ in vim we can use C-\ here
#bind -T root C-\ next
# But also C-\ is often stty quit ...
# if not #{alternate_on} dont send C-\ key
# data to prevent extraneous chars in output
# NOTE: C-\ used by zsh/bash auto-suggest ...
#bind-key -T root C-\\ \
#    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
#        "if-shell -Ft= '#{alternate_on}' \
#            'send-keys C-\\' \
#            ''"

# if not #{alternate_on} dont send C-n key
# data to prevent extraneous chars in output
bind-key -T root C-n \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'send-keys C-n' \
            ''"

# SPECIAL: C-BSpace in terminals is mapped to M-BSpace
bind -T root M-BSpace next

# ccsm uses M-Space as Window menu
#bind -T root M-Space next

# zig-zag traversal
#bind -T root C-Space run "tmux select-window -t $(if [ ! -f /dev/shm/tmux_dir ] ; then echo 2 > /dev/shm/tmux_dir ; fi ; wcnt=$(tmux list-windows | wc -l) ; dir=$(cat /dev/shm/tmux_dir) ; d0=$((\$dir&1)) ; d1=$((\$dir&6)) ; if [ \$d0 -eq 1 ] ; then if [ \$d1 -eq 2 ] ; then d1=4 ; else d1=2 ; fi; fi ; if [ \$d1 -eq 2 ] ; then if [ #I -gt 1 ] ; then echo $((#I-1)) ; else echo 4 > /dev/shm/tmux_dir ; if [ #I -lt \$wcnt ] ; then echo $((#I+1)) ; else echo 1 ; fi ; fi ; else if [ #I -lt \$wcnt ] ; then echo $((#I+1)) ; else echo 2 > /dev/shm/tmux_dir ; if [ #I -gt 1 ] ; then echo $((#I-1)) ; else echo 1 ; fi ; fi ; fi)"

# prev ------

# existing mappings:
#bind-key -T prefix C-h     previous-window
#bind-key -T prefix BSpace  previous-window
#bind-key -T prefix C-p     previous-window
#bind-key -T prefix p       previous-window
#bind-key -T prefix M-p     previous-window -a

unbind-key -T prefix C-p
bind-key -T prefix C-p display-panes \; display-panes

# prefix-M-p may be used for copyq popup below ...
unbind-key -T prefix M-p

# C-Left used in vim for prev word
# M-Left used in vim for prev tab

#bind-key -r -T prefix Left prev
#bind-key -r -T prefix C-Left prev
bind-key -T prefix Left   select-pane -L
bind-key -T prefix C-Left select-pane -L
# Super-Left (used by unity/terminator ?)
# S-Left used by tmux to traverse panes - changed above
# used now to nav windows ...
bind-key -T root S-Left prev
# C-M-Left does not seem to work in tmux

# overloading C-Left is too confusing
#bind -T root C-Left \
#	if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
#		"if-shell -Ft= '#{alternate_on}' \
#			'send-keys C-Left' \
#			'prev'"

# could also be shell backward-kill-word
#bind -T root C-p prev
# if not #{alternate_on} dont send C-p key
# data to prevent extraneous chars in output
bind-key -T root C-p \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'send-keys C-p' \
            ''"

# SPECIAL: C-S-BSpace in terminals is mapped to M-2
bind -T root M-2 prev

# SPECIAL: C-= in terminals is mapped to M-3
bind -T root M-3 prev

bind -T root C-Space prev

# zig-zag traversal
#bind -T root C-p run "tmux select-window -t $(if [ ! -f /dev/shm/tmux_dir ] ; then echo 5 > /dev/shm/tmux_dir ; fi ; wcnt=$(tmux list-windows | wc -l) ; dir=$(cat /dev/shm/tmux_dir) ; d0=$((\$dir&1)) ; d1=$((\$dir&6)) ; if [ \$d0 -eq 0 ] ; then if [ \$d1 -eq 2 ] ; then d1=4 ; else d1=2 ; fi ; fi ; if [ \$d1 -eq 2 ] ; then if [ #I -gt 1 ] ; then echo $((#I-1)) ; else echo 5 > /dev/shm/tmux_dir ; if [ #I -lt \$wcnt ] ; then echo $((#I+1)) ; else echo 1 ; fi ; fi ; else if [ #I -lt \$wcnt ] ; then echo $((#I+1)) ; else echo 3 > /dev/shm/tmux_dir ; if [ #I -gt 1 ] ; then echo $((#I-1)) ; else echo 1 ; fi ; fi ; fi)"

# -----------

# NOTE: S-Left,Right used for nav windows now

unbind-key -T root S-Up
unbind-key -T root S-Down

# NOTE: S-Up   available ...
# NOTE: S-Down available ...

# if not #{alternate_on} dont send S-Up,Down key
# data to prevent extraneous chars in output
bind -T root S-Up \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'send-keys -l [1\\;2A'"

bind -T root S-Down \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'send-keys -l [1\\;2B'"

bind-key -T prefix Up     select-pane -U
bind-key -T prefix C-Up   select-pane -U

bind-key -T prefix Down   select-pane -D
bind-key -T prefix C-Down select-pane -D

# -----------

# SPECIAL: C-S-Space in terminals is mapped to M-4
bind -T root         M-4 choose-tree
bind -T copy-mode-vi M-4 choose-tree

# -----------

# NOTE: C-M-p used by parcellite
# NOTE: C-S-p used by terminator
# NOTE: C-M-U/D used by gnome winmgr

# -----------

# pop up copyq clipboard ...
# NOTE: used to be M-p ...
# use M-Insert because we can map that in the app to toggle as well ...
bind-key -T root M-Insert run "copyq >/dev/null 2>/dev/null toggle"

# -----------

# copy-mode

# Enter copy-mode with 'prefix-[' (also prefix-Esc)
# when entering copy-mode, clear primary clipboard
# so mouse paste from window mgr does send any data
bind-key -T prefix [ \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'copy-mode' \
            'copy-mode ; send -XN 2 cursor-left'"
# dont add C-[ as that is also Esc

# ']' was originally set to paste-buffer
# but its nice to also go into copy-mode
bind-key -T prefix ] \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'copy-mode' \
            'copy-mode ; send -XN 2 cursor-left'"
# also add C-] as that is easily pressed
bind-key -T prefix C-] \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'copy-mode' \
            'copy-mode ; send -XN 2 cursor-left'"

# if not #{alternate_on} dont send C-] key
# data to prevent extraneous chars in output
bind-key -T root C-] \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'send-keys C-]' \
            ''"

# if not #{alternate_on} dont send C-o key
# data to prevent extraneous chars in output
bind-key -T root C-o \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'send-keys C-o'\
            ''"

# if not #{alternate_on} dont send C-_ (really C-/) key
# data to prevent extraneous chars in output
# NOTE: now used in fzf preview ...
#bind-key -T root C-_ \
#    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
#        "if-shell -Ft= '#{alternate_on}' \
#            'send-keys C-_' \
#            ''"

# C-z for pane zoom
# use shell C-t to get fzf without popup
bind-key -T prefix z \
    if-shell -Ft= "#{pane_in_mode}" \
        "" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            \"\" \
            \"popup -d '#{pane_current_path}' -x R -y S -w 80% -h 80% -E -K -R \\\"fzf > /dev/shm/tmpfzf\$\$ ; if [ -s /dev/shm/tmpfzf\$\$ ] ; then tmux load-buffer /dev/shm/tmpfzf\$\$ ; tmux paste-buffer -s ' ' -d ; fi ; rm -f /dev/shm/tmpfzf\$\$\\\"\""

# vim may remap C-y to paste before cursor ...
# default mapping in copy-mode-vi is scroll-up
unbind-key -T copy-mode-vi C-y
# if not #{alternate_on} dont send C-y key
# data to prevent extraneous chars in output
bind-key -T root C-y \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'send-keys C-y' \
            ''"
# or should C-y paste from root and/or copy-mode ?

# =================================================

# NOTE: rule for embedded quotes is 2x+1 so: 1, 3, 7, 15, 31 ...

# global add space toggle (look into set-environment, update-environment)
# NOTE: coordinate any changes here with $BYOBU_CONFIG_DIR/bin/5_addspc
# if pane_current_command contains *ssh* then set ginfo to n/a ...
bind -n C-F12 run "pcmd=\"#{pane_current_command}\" ; if [ \"\${pcmd####*ssh*}\" ] ; then ginfo=\$(gitinfo #{pane_current_path}); else ginfo=\"git:<n/a>\" ; fi ; if [ ! -s /dev/shm/tmux#{session_name}.spc ] ; then add=1 ; else add=$(cat /dev/shm/tmux#{session_name}.spc) ; fi ; if [ \$add -eq 1 ] ; then echo 0 > /dev/shm/tmux#{session_name}.spc ; echo \"#[default]#[fg=colour13,bold,bg=\\#333333]- \$ginfo#[default]#[fg=\\#EEEEEE]#[bg=\\#333333] \" > $BYOBU_RUN_DIR/cache.tmux/custom.5_addspc ; tmux display-message \"Add Space: OFF \$ginfo\" ; else echo 1 > /dev/shm/tmux#{session_name}.spc ; echo \"#[default]#[fg=colour13,bold,bg=\\#333333]+ \$ginfo#[default]#[fg=\\#EEEEEE]#[bg=\\#333333] \" > $BYOBU_RUN_DIR/cache.tmux/custom.5_addspc ; tmux display-message \"Add Space: ON \$ginfo\" ; fi ; tr -d '\n' < $BYOBU_RUN_DIR/cache.tmux/custom.5_addspc > $BYOBU_RUN_DIR/status.tmux/custom" \; refresh-client -S \; refresh-client -S

# NOTE: TMUX_VI_MODE manually tell tmux we are in vi ...
#bind -n C-F11 run "vmd=\$(tmux show-environment -g TMUX_VI_MODE 2>/dev/null | awk -F= '{print \$2}') ; if [ \"\$vmd\" != \"1\" ] ; then tmux set-environment -g TMUX_VI_MODE 1 ; tmux display-message \"vi mode: ON\" ; else tmux set-environment -g TMUX_VI_MODE 0 ; tmux display-message \"vi mode: OFF\" ; fi"

# =================================================

# do we want to add space (based on config) to clipboard if we cancel copy-mode ?
# (y)ank does not add space, (Y)ank does add space
# dragging mouse for selection does not, Esc to cancel does not
# DoubleClick and Ctrl-Click and Alt-Click add space to clipboard
# \ws, C-s-v, C-Insert, M-Insert add space

# NOTE: if bracketed-paste in shell is not enabled then could use paste-buffer -s ' ' instead of -p ...
# TODO: could have a toggle for this

# put selection into tmux buffer, then paste from that ...
# bind-key C-p run "tmux set-buffer \"$(xclip -o -selection clipboard)\"; tmux paste-buffer")

# in copy-mode, if selection then cancel and paste; else cancel, paste from clipboard
# in root mode, if alternate do nothing (TODO: or perhaps send C-s v); else paste from clipboard
# TODO: in root mode, if alternate - enter copy-mode
# C-s v
bind-key -T prefix v \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'copy-mode ; send -l v' \
            'if-shell -Ft= \"#{pane_in_mode}\" \
                \"if-shell -Ft= \\\"#{selection_present}\\\" \
                    \\\"send -X copy-pipe-and-cancel \\\\\\\"myclip ; tmux wait -S pipe\\\\\\\" ; wait pipe ; run \\\\\\\"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\\\\\\\\\\\\\"<clipboard empty>\\\\\\\\\\\\\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$\\\\\\\"\\\" \
                    \\\"send -X cancel ; run \\\\\\\"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\\\\\\\\\\\\\"<clipboard empty>\\\\\\\\\\\\\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$\\\\\\\" \\\" \" \
                \"run \\\"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\\\\\"<clipboard empty>\\\\\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$\\\" \" ' "

# C-s V (same as C-s v above but send V)
bind-key -T prefix V \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'copy-mode ; send -l V' \
            'if-shell -Ft= \"#{pane_in_mode}\" \
                \"if-shell -Ft= \\\"#{selection_present}\\\" \
                    \\\"send -X copy-pipe-and-cancel \\\\\\\"myclip ; tmux wait -S pipe\\\\\\\" ; wait pipe ; run \\\\\\\"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\\\\\\\\\\\\\"<clipboard empty>\\\\\\\\\\\\\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$\\\\\\\"\\\" \
                    \\\"send -X cancel ; run \\\\\\\"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\\\\\\\\\\\\\"<clipboard empty>\\\\\\\\\\\\\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$\\\\\\\" \\\" \" \
                \"run \\\"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\\\\\"<clipboard empty>\\\\\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$\\\" \" ' "

# C-s C-v (same as C-s v above but send ^V)
bind-key -T prefix C-v \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'copy-mode ; send -l ' \
            'if-shell -Ft= \"#{pane_in_mode}\" \
                \"if-shell -Ft= \\\"#{selection_present}\\\" \
                    \\\"send -X copy-pipe-and-cancel \\\\\\\"myclip ; tmux wait -S pipe\\\\\\\" ; wait pipe ; run \\\\\\\"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\\\\\\\\\\\\\"<clipboard empty>\\\\\\\\\\\\\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$\\\\\\\"\\\" \
                    \\\"send -X cancel ; run \\\\\\\"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\\\\\\\\\\\\\"<clipboard empty>\\\\\\\\\\\\\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$\\\\\\\" \\\" \" \
                \"run \\\"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\\\\\"<clipboard empty>\\\\\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$\\\" \" ' "

# =================================================

# Delete is DC or Delete
# Insert is IC or Insert
# Backspace is BSpace

# trailing space ...

# TODO: could have a TMUX_VI_MODE check ...
bind-key   -T root C-Insert \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -F '#{m/r:(@v:),#{q:pane_title}}' \
            \"send C-Insert\" \
            \"run \\\"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\\\\\"<clipboard empty>\\\\\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$\\\"\""

bind-key   -T copy-mode-vi C-Insert \
    if-shell -Ft= "#{selection_present}" \
        "send -X copy-pipe-and-cancel \"myclip ; tmux wait -S pipe\" ; wait pipe ; run \"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\"<clipboard empty>\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$\" " \
        "send -X cancel ; run \"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\"<clipboard empty>\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$\""

# SPECIAL: [some] terminals might map C-Insert to M-1 ...
# TODO: could have a TMUX_VI_MODE check ...
unbind-key -T root M-1
bind-key   -T root M-1 \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -F '#{m/r:(@v:),#{q:pane_title}}' \
            \"send M-1\" \
            \"run \\\"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\\\\\"<clipboard empty>\\\\\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$\\\"\""

unbind-key -T copy-mode-vi M-1
bind-key   -T copy-mode-vi M-1 \
    if-shell -Ft= "#{selection_present}" \
        "send -X copy-pipe-and-cancel \"myclip ; tmux wait -S pipe\" ; wait pipe ; run \"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\"<clipboard empty>\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$\" " \
        "send -X cancel ; run \"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\"<clipboard empty>\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$\""

# -------

# leading space ...

# TODO: could have a TMUX_VI_MODE check ...
bind-key   -T root C-S-Insert \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -F '#{m/r:(@v:),#{q:pane_title}}' \
            \"send C-S-Insert\" \
            \"run \\\"if [ ! -s /dev/shm/tmux#{session_name}.spc ] ; then add=1 ; else add=\$(cat /dev/shm/tmux#{session_name}.spc) ; fi ; if [ \\\\\\\$add -eq 1 ] ; then xsel -o -b --rmlastnl --sc 0 > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux send Space ; tmux paste-buffer -dp ; else tmux display-message \\\\\\\"<clipboard empty>\\\\\\\"; fi ; rm -f /dev/shm/tmpbuf\$\$ ; else xsel -o -b --rmlastnl --sc 0 > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\\\\\"<clipboard empty>\\\\\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$ ; fi\\\"\""

bind-key   -T copy-mode-vi C-S-Insert \
    if-shell -Ft= "#{selection_present}" \
        "send -X copy-pipe-and-cancel \"myclip ; tmux wait -S pipe\" ; wait pipe ; run \"if [ ! -s /dev/shm/tmux#{session_name}.spc ] ; then add=1 ; else add=\$(cat /dev/shm/tmux#{session_name}.spc) ; fi ; if [ \\\$add -eq 1 ] ; then xsel -o -b --rmlastnl --sc 0 > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux send Space ; tmux paste-buffer -dp ; else tmux display-message \\\"<clipboard empty>\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$ ; else xsel -o -b --rmlastnl --sc 0 > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\"<clipboard empty>\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$ ; fi\"" \
        "send -X cancel ; run \"if [ ! -s /dev/shm/tmux#{session_name}.spc ] ; then add=1 ; else add=\$(cat /dev/shm/tmux#{session_name}.spc) ; fi ; if [ \\\$add -eq 1 ] ; then xsel -o -b --rmlastnl --sc 0 > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux send Space ; tmux paste-buffer -dp ; else tmux display-message \\\"<clipboard empty>\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$ ; else xsel -o -b --rmlastnl --sc 0 > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\"<clipboard empty>\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$ ; fi\""

# SPECIAL: [some] terminals might map C-S-Insert to M-8 ...
# SPECIAL: if vi/vim then send M-8 to differentiate key / menu paste (still trailing space, not same as C-S-Ins leading space) ...
# TODO: could have a TMUX_VI_MODE check ...
unbind-key -T root M-8
bind-key   -T root M-8 \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -F '#{m/r:(@v:),#{q:pane_title}}' \
            \"send M-8\" \
            \"run \\\"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\\\\\"<clipboard empty>\\\\\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$\\\"\""

unbind-key -T copy-mode-vi M-8
bind-key   -T copy-mode-vi M-8 \
    if-shell -Ft= "#{selection_present}" \
        "send -X copy-pipe-and-cancel \"myclip ; tmux wait -S pipe\" ; wait pipe ; run \"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\"<clipboard empty>\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$\"" \
        "send -X cancel ; run \"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\"<clipboard empty>\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$\""

# -----------------

# some terminal configs (urxvt) map C-S-c => M-7
# C-S-c - copy
# SPECIAL: also if vi/vim then menu copy ...
# TODO: could have a TMUX_VI_MODE check ...
bind-key -T root M-7 \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -F '#{m/r:(@v:),#{q:pane_title}}' \
            \"send M-7\" \
            \"send C-S-C\""

bind-key -T copy-mode-vi M-7 \
    if -F "#{selection_present}" \
        "send-keys -X copy-pipe-and-cancel \"myclip ; tmux wait -S pipe\" ; wait pipe ; display-message \"copied to clipboard\""

# some terminal configs (urxvt) map C-S-v => M-1 / M-8
# M-1 already mapped above

# some terminal configs (urxvt) map C-S-x => M-9
# SPECIAL: also if vi/vim then menu cut ...
# TODO: could have a TMUX_VI_MODE check ...
bind-key -T root M-9 \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -F '#{m/r:(@v:),#{q:pane_title}}' \
            \"send M-9\" \
            \"send C-S-X\""

# NOTE: seems we need to explicitly send this key ...
# NOTE: used above for copyq toggle ...
#bind-key -T root M-Insert send M-Insert

# =================================================

bind-key -T copy-mode-vi Home send-keys -X start-of-line
bind-key -T copy-mode-vi End  send-keys -X end-of-line

bind-key -T copy-mode-vi C-Home send-keys -X history-top
bind-key -T copy-mode-vi C-End  send-keys -X history-bottom \; send -l 0$
# SPECIAL: terminator maps <C-Home> to <Esc>5
bind-key -T copy-mode-vi M-5    send-keys -X history-top
# SPECIAL: terminator maps <C-End> to <Esc>6
bind-key -T copy-mode-vi M-6    send-keys -X history-bottom \; send -l 0$

# if cursor-down-and-copy command exists ... but leave j alone
bind-key -T copy-mode-vi Down   if -F "#{selection_present}" "send -X cursor-down" "send -X cursor-down-and-cancel"

# TODO: what we really want is to scroll-down-and-cancel UNLESS a selection is ACTIVE
# vim-like mappings for copy-mode cut/paste ...
bind-key -T copy-mode-vi C-j    if -F "#{selection_active}" "send -X scroll-down" "send -X scroll-down-and-cancel"
bind-key -T copy-mode-vi C-Down if -F "#{selection_active}" "send -X scroll-down" "send -X scroll-down-and-cancel"
bind-key -T copy-mode-vi C-k    send-keys -X scroll-up
bind-key -T copy-mode-vi C-Up   send-keys -X scroll-up

bind-key -T copy-mode-vi C-a send-keys -X start-of-line
bind-key -T copy-mode-vi C-e send-keys -X end-of-line

# TODO: append selection ?
unbind   -T copy-mode-vi A
#bind-key -T copy-mode-vi A send-keys -X append_selection

# only real difference is C-v starts a new selection here but toggles in vim
# V for line selection
# C-v for rect selection from current col
#bind-key -T copy-mode-vi C-v send-keys -X begin-selection \; send-keys -X rectangle-toggle
# seems a little better ...
#bind-key -T copy-mode-vi v   if -F "#{selection_present}" "" "send-keys -X begin-selection"
#bind-key -T copy-mode-vi V   if -F "#{selection_present}" "" "send-keys -X select-line"
# allow for v/V change ...
# TODO: can we remember selection_start_x,y and toggle v/V keeping the start/end x,y ?
bind-key -T copy-mode-vi v   if -F "#{selection_present}" "send -X other-end ; send -X clear-selection ; send -X begin-selection" "send -X begin-selection"
bind-key -T copy-mode-vi V   if -F "#{selection_present}" "send -X other-end ; send -X clear-selection ; send -X select-line" "send -X select-line"
bind-key -T copy-mode-vi C-v if -F "#{selection_present}" "send -X rectangle-toggle" "send -X begin-selection ; send -X rectangle-toggle"

# enter copy-mode and start selection
#bind-key -T prefix v copy-mode \; send-keys -X begin-selection
# conflicts with vertical split
#bind-key -T prefix V copy-mode \; send-keys -X select-line

# <Leader>ws - match vim word-select
# NOTE: these do NOT yank/copy ...
bind-key -T copy-mode-vi '\' switch-client -T LEADER
bind-key -T LEADER w switch-client -T LEADER
bind-key -T LEADER s send -X clear-selection \; send-keys -l lbvhe
# <Leader>wS - match vim WORD (lBvhE) - NOTE: tmux word-separators are different than vim and this is not much different than lbvhe
bind-key -T LEADER S send -X clear-selection \; send-keys -l lBvhE
# <Leader>wp - match C-DoubleClick1 to select whole file path
bind-key -T LEADER p send -X clear-selection \; set word-separators " ='`;:+|[](){},?\\\"" \; send -l lbvhe \; set word-separators " ='`;:+|[](){},/?\\\""
# for P - remove : to get https:// etc urls - but really about the same as \wS ...
bind-key -T LEADER P send -X clear-selection \; set word-separators " ='`;+|[](){},?\\\"" \; send -l lbvhe \; set word-separators " ='`;:+|[](){},/?\\\""

# if selection active then continue in search mode, otherwise clear it
bind-key -T copy-mode-vi '/' command-prompt -p 'search/:' 'if -F "#{selection_active}" "run \"tmux copy-mode ; tmux send -X search-forward %1"\" "run \"tmux copy-mode ; tmux send -X clear-selection ; tmux send -X search-forward %1\""'
bind-key -T copy-mode-vi '?' command-prompt -p 'search?:' 'if -F "#{selection_active}" "run \"tmux copy-mode ; tmux send -X search-backward %1"\" "run \"tmux copy-mode ; tmux send -X clear-selection ; tmux send -X search-backward %1\""'

# change n/N so n is always forward and N is always backward
#bind-key -T copy-mode-vi n send-keys -X search-forward #{pane_search_string}
#bind-key -T copy-mode-vi N send-keys -l h \; send-keys -X search-backward #{pane_search_string}

# NOTE: could use newer send -FX #{copy_cursor_word} to get cursor under word, insead of send -l lbvhe ...
# <Leader>wf - match vim search for word under cursor
# copy word/selection to clipboard
# dont copy word/selection to clipboard
bind-key -T LEADER f         if -F "#{selection_present}" "send -X stop-selection ; send -X copy-pipe-no-clear \"tmux load-buffer -b tmpbuf - ; tmux wait -S pipe\" ; wait pipe ; run \"sw=\$(tmux show-buffer) ; tmux copy-mode ; tmux send -X search-forward \\\${sw}\"" "send -X clear-selection ; send-keys -l lbvhe ; send -X stop-selection ; send -X copy-pipe-no-clear \"tmux load-buffer -b tmpbuf - ; tmux wait -S pipe\" ; wait pipe ; run \"sw=\$(tmux show-buffer) ; tmux copy-mode ; tmux send -X search-forward \\\${sw}\"" \; delete-buffer -b tmpbuf

# and *
# copy word/selection to clipboard
# dont copy word/selection to clipboard
bind-key -T copy-mode-vi '*' if -F "#{selection_present}" "send -X stop-selection ; send -X copy-pipe-no-clear \"tmux load-buffer -b tmpbuf - ; tmux wait -S pipe\" ; wait pipe ; run \"sw=\$(tmux show-buffer) ; tmux copy-mode ; tmux send -X search-forward \\\${sw}\"" "send -X clear-selection ; send-keys -l lbvhe ; send -X stop-selection ; send -X copy-pipe-no-clear \"tmux load-buffer -b tmpbuf - ; tmux wait -S pipe\" ; wait pipe ; run \"sw=\$(tmux show-buffer) ; tmux copy-mode ; tmux send -X search-forward \\\${sw}\"" \; delete-buffer -b tmpbuf

# <Leader>wF - match vim search backward for word under cursor
# copy word/selection to clipboard
# dont copy word/selection to clipboard
bind-key -T LEADER F         if -F "#{selection_present}" "send -X stop-selection ; send -X copy-pipe-no-clear \"tmux load-buffer -b tmpbuf - ; tmux wait -S pipe\" ; wait pipe ; run \"sw=\$(tmux show-buffer) ; tmux copy-mode ; tmux send -X search-backward \\\${sw}\"" "send -X clear-selection ; send-keys -l lbvhe ; send -X stop-selection ; send -X copy-pipe-no-clear \"tmux load-buffer -b tmpbuf - ; tmux wait -S pipe\" ; wait pipe ; run \"sw=\$(tmux show-buffer) ; tmux copy-mode ; tmux send -X search-backward \\\${sw}\"" \; delete-buffer -b tmpbuf

# and '#' - put in single quotes
# copy word/selection to clipboard
# dont copy word/selection to clipboard
bind-key -T copy-mode-vi '#' if -F "#{selection_present}" "send -X stop-selection ; send -X copy-pipe-no-clear \"tmux load-buffer -b tmpbuf - ; tmux wait -S pipe\" ; wait pipe ; run \"sw=\$(tmux show-buffer) ; tmux copy-mode ; tmux send -X search-backward \\\${sw}\"" "send -X clear-selection ; send-keys -l lbvhe ; send -X stop-selection ; send -X copy-pipe-no-clear \"tmux load-buffer -b tmpbuf - ; tmux wait -S pipe\" ; wait pipe ; run \"sw=\$(tmux show-buffer) ; tmux copy-mode ; tmux send -X search-backward \\\${sw}\"" \; delete-buffer -b tmpbuf

# mid-screen, there is already M ...
# C-? (really C-_) like vim
bind-key -T copy-mode-vi C-_ send -l M

# also <Leader>ct like vim
bind-key -T LEADER c switch-client -T LEADER2
bind-key -T LEADER2 t send -l M

# also zz like vim
bind-key -T copy-mode-vi z switch-client -T LEADER3
bind-key -T LEADER3 z send -l M

# match vim word nav
bind-key -T copy-mode-vi C-Right send-keys -l w
bind-key -T copy-mode-vi C-Left  send-keys -l b

# disable prefix-d to detach (only use prefix C-d)
unbind-key -T prefix d

# should Return/Enter copy and cancel ?
#orig: bind-key   -T copy-mode-vi Enter send-keys -X copy-selection-and-cancel
# same as y(ank) or C-c
#bind-key -T copy-mode-vi Enter send-keys C-c
#unbind-key -T copy-mode-vi Enter
# NOTE: to match vim ...
bind-key -T copy-mode-vi Enter send-keys Down \; send-keys Home
# NOTE: like vim, <A-CR> to yank and quit copy-mode ...
bind-key -T copy-mode-vi M-Enter send-keys C-c

# default is for Space to begin-selection
#unbind-key -T copy-mode-vi Space
# map Space to clear selection ???
#bind-key   -T copy-mode-vi Space send-keys -X clear-selection
# NOTE: to match vim ...
bind-key -T copy-mode-vi Space send-keys Right

# map Esc to quit copy-mode (as in vi)
bind-key   -T copy-mode-vi Escape send-keys -X cancel

# default is for q to quit copy-mode
#unbind-key -T copy-mode-vi q
# map q to clear selection ???
bind-key   -T copy-mode-vi q send -X stop-selection \; send -X clear-selection

bind-key   -T copy-mode-vi x send-keys -X stop-selection

# an alternative to Esc to cancel copy-mode
bind-key   -T copy-mode-vi C-q send-keys -X cancel
# TODO: can we use qq ? (but already mapped single q above ...)

# more meaningful cmd-prompt
bind -T prefix : command-prompt -p "tmux:"

# yank to clipboard ...
#
# no longer use tmux-yank plugin
# https://github.com/tmux-plugins/tmux-yank.git
#set -g @copy_mode_yank "C-c"
#set -g @shell_mode "vi"
#run-shell ~/.byobu/tmux-yank/yank.tmux

# NOTE: re: selection and appending trailing space ...
# C-c, y (yank) and mouse drag do NOT add trailing space - we assume you are yanking exactly what you want
# Most other selection methods (double-click, \ws, status-left-click, etc.) assume some sort of
# cmd-line paste and add a trailing space if configured to do so (C-F12)

# TODO: check if selection is empty before saving with myclip (and echoing copied ...)
# BUG: should wait for copy-pipe, but wait pipe hangs if selection is outside range ...

# if no selection then cancel copy-mode
bind-key -T copy-mode-vi C-c if -F "#{selection_present}" \
    "send-keys -X copy-pipe-no-clear \"tmux load-buffer -b tmpbuf - ; tmux wait -S pipe\" ; wait pipe ; run \"exst=\\\$(tmux list-buffers | awk '{print \\\$1}' | grep 'tmpbuf:') ; if [ -n \\\"\\\$exst\\\" ] ; then tmux show-buffer -b tmpbuf | myclip ; tmux delete-buffer -b tmpbuf ; tmux display-message \\\"copied to clipboard\\\" ; fi\" ; send -X cancel" \
    "send -X cancel"

# also map 'y' to match vim yank
# if no selection then no-op
bind-key -T copy-mode-vi y if -F "#{selection_present}" \
    "send-keys -X copy-pipe-no-clear \"tmux load-buffer -b tmpbuf - ; tmux wait -S pipe\" ; wait pipe ; run \"exst=\\\$(tmux list-buffers | awk '{print \\\$1}' | grep 'tmpbuf:') ; if [ -n \\\"\\\$exst\\\" ] ; then tmux show-buffer -b tmpbuf | myclip ; tmux delete-buffer -b tmpbuf ; tmux display-message \\\"copied to clipboard\\\" ; fi\" ; send -X cancel"

# Y to add trailing space if enabled
bind-key -T copy-mode-vi Y if -F "#{selection_present}" \
    "send-keys -X copy-pipe-no-clear \"tmux load-buffer -b tmpbuf - ; tmux wait -S pipe\" ; wait pipe ; run \"exst=\\\$(tmux list-buffers | awk '{print \\\$1}' | grep 'tmpbuf:') ; if [ -n \\\"\\\$exst\\\" ] ; then tmux show-buffer -b tmpbuf | myclip ; tmux delete-buffer -b tmpbuf ; tmux display-message \\\"copied to clipboard\\\" ; fi\" ; send -X cancel"

# ----------------------------------------------

# NOTE: use SecondClick to avoid delay between DoubleClick and TripleClick
#       if NEED difference between DoubleClick and TripleClick then use DoubleClick instead of SecondClick

# NOTE: if it was single, need to use Down instead of Up on the single-click so the DoubleClick of the same gets run last
# remove : to get https:// etc urls ...
# TODO: if we want C-Click to end copy-mode ...
bind   -T copy-mode-vi C-DoubleClick1Pane \
    select-pane \; send -X clear-selection \; set word-separators " ='`;+|[](){},?\\\"" \; send -l lbvhe \; send -X stop-selection \; set word-separators " ='`;:+|[](){},/?\\\"" \; send -X copy-pipe-no-clear "myclip ; tmux wait -S pipe" \; wait pipe \; run "sleep 0.30" \; send -X cancel
# C-TripleClick1Pane select whole line - NOTE: need to use Down instead of Up if we mapped single; does NOT allow extend
bind   -T copy-mode-vi C-TripleClick1Pane \
    select-pane \; send -X clear-selection \; set word-separators " ='`;+|[](){},?\\\"" \; send -l lBvhE \; send -X stop-selection \; set word-separators " ='`;:+|[](){},/?\\\"" \; send -X copy-pipe-no-clear "myclip ; tmux wait -S pipe" \; wait pipe \; run "sleep 0.30" \; send -X cancel
unbind -T copy-mode-vi C-SecondClick1Pane

# same as above, but cancel copy mode - could also paste to cmdline then optionally send Space
# use DoubleClick so we dont get extras easily
# remove : to get https:// etc urls ...
bind   -T copy-mode-vi M-SecondClick1Pane \
    select-pane \; send -X clear-selection \; set word-separators " ='`;+|[](){},?\\\"" \; send -l lbvhe \; send -X stop-selection \; set word-separators " ='`;:+|[](){},/?\\\"" \; send -X copy-pipe-no-clear "myclip ; tmux wait -S pipe" \; wait pipe \; run "sleep 0.30" \; if -F "#{||:#{alternate_on},#{mouse_any_flag}}" "send -X cancel" "send -X cancel ; run \"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\"<clipboard empty>\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$\""
# TODO: not sure we can get triple because we leave copy-mode on second above and we are not using double ...
bind   -T copy-mode-vi M-TripleClick1Pane \
    select-pane \; send -X clear-selection \; set word-separators " ='`;+|[](){},?\\\"" \; send -l lBvhE \; send -X stop-selection \; set word-separators " ='`;:+|[](){},/?\\\"" \; send -X copy-pipe-no-clear "myclip ; tmux wait -S pipe" \; wait pipe \; run "sleep 0.30" \; if -F "#{||:#{alternate_on},#{mouse_any_flag}}" "send -X cancel" "send -X cancel ; run \"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\"<clipboard empty>\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$\""
unbind -T copy-mode-vi M-DoubleClick1Pane

# NOTE: if it was single, need to use Down instead of Up on the single-click so the DoubleClick of the same gets run last
# remove : to get https:// etc urls ...
# NOTE: alternate_on check helps even tho it is not directly related to mouse events ...
# TODO: if we want C-Click to end copy-mode ...
bind   -T root C-DoubleClick1Pane \
    if-shell -F '#{m/r:(@v:),#{q:pane_title}}' \
        "send-keys -M" \
        "if-shell -F \"#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}\" \
            \"send-keys -M\" \
            \"select-pane ; copy-mode -H ; send -X clear-selection ; set word-separators \\\" ='`;+|[](){},?\\\\\\\\\\\\\\\"\\\" ; send -l lbvhe ; send -X stop-selection ; set word-separators \\\" ='`;:+|[](){},/?\\\\\\\\\\\\\\\"\\\" ; send -X copy-pipe-no-clear \\\"myclip ; tmux wait -S pipe\\\" ; wait pipe ; run \\\"sleep 0.30\\\" ; send -X cancel\""
# C-TripleClick1Pane select whole line - NOTE: need to use Down instead of Up if we mapped single; does NOT allow extend
# NOTE: TMUX_VI_MODE manually tell tmux we are in vi ... - special M-c key for vim to know its a triple-click ...
bind   -T root C-TripleClick1Pane \
    if-shell -F '#{m/r:(@v:),#{q:pane_title}}' \
        "send-keys M-c" \
        "if-shell -F \"#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}\" \
            \"send-keys -M\" \
            \"select-pane ; copy-mode -H ; send -X clear-selection ; set word-separators \\\" ='`;+|[](){},?\\\\\\\\\\\\\\\"\\\" ; send -l lBvhE ; send -X stop-selection ; set word-separators \\\" ='`;:+|[](){},/?\\\\\\\\\\\\\\\"\\\" ; send -X copy-pipe-no-clear \\\"myclip ; tmux wait -S pipe\\\" ; wait pipe ; run \\\"sleep 0.30\\\" ; send -X cancel\""
unbind -T root C-SecondClick1Pane

# same as above, but cancel copy mode - could also paste to cmdline then optionally send Space
# use DoubleClick so we dont get extras easily
# remove : to get https:// etc urls ...

# TODO: if alt_on or mouse then dont paste, just copy and exit ...
bind   -T root M-DoubleClick1Pane \
    if-shell -F '#{m/r:(@v:),#{q:pane_title}}' \
        "send-keys -M" \
        "if-shell -F \"#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}\" \
            \"send-keys -M\" \
            \"select-pane ; copy-mode -H ; send -X clear-selection ; set word-separators \\\" ='`;+|[](){},?\\\\\\\\\\\\\\\"\\\" ; send -l lbvhe ; send -X stop-selection ; set word-separators \\\" ='`;:+|[](){},/?\\\\\\\\\\\\\\\"\\\" ; send -X copy-pipe-no-clear \\\"myclip ; tmux wait -S pipe\\\" ; wait pipe ; run \\\"sleep 0.30\\\" ; send -X cancel ; if -F \\\"#{?#{||:#{alternate_on},#{mouse_any_flag}},0,1}\\\" \\\"run \\\\\\\"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\\\\\\\\\\\\\"<clipboard empty>\\\\\\\\\\\\\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$\\\\\\\"\\\"\""
# TODO: not sure we can get triple because we leave copy-mode on second above and we are not using double ...
# NOTE: TMUX_VI_MODE manually tell tmux we are in vi ... - special M-b key for vim to know its a triple-click ...
bind   -T root M-TripleClick1Pane \
    if-shell -F '#{m/r:(@v:),#{q:pane_title}}' \
        "send-keys M-b" \
        "if-shell -F \"#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}\" \
            \"send-keys -M\" \
            \"select-pane ; copy-mode -H ; send -X clear-selection ; set word-separators \\\" ='`;+|[](){},?\\\\\\\\\\\\\\\"\\\" ; send -l lBvhE ; send -X stop-selection ; set word-separators \\\" ='`;:+|[](){},/?\\\\\\\\\\\\\\\"\\\" ; send -X copy-pipe-no-clear \\\"myclip ; tmux wait -S pipe\\\" ; wait pipe ; run \\\"sleep 0.30\\\" ; send -X cancel ; if -F \\\"#{?#{||:#{alternate_on},#{mouse_any_flag}},0,1}\\\" \\\"run \\\\\\\"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\\\\\\\\\\\\\"<clipboard empty>\\\\\\\\\\\\\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$\\\\\\\"\\\"\""
unbind -T root M-SecondClick1Pane

# ==============================================

# Status ...

# LEFT - root mode - if cmdline not empty clear it, same for C-/M- ...

#    if-shell -Ft= '#{?#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}},0,1}' \

bind   -T root SecondClick1StatusLeft \
    if-shell -Ft= '#{?#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}},0,1}' \
        "run \"nf=\\\$(tmux capture-pane -p | tac | sed '/^$/d' | head -n 1 | awk '{print NF-1}') ; if [ \\\$nf -gt 0 ] ; then tmux send-keys -l  ; fi\""
# triple is the same as second/double ...
bind   -T root TripleClick1StatusLeft \
    if-shell -Ft= '#{?#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}},0,1}' \
        "run \"nf=\\\$(tmux capture-pane -p | tac | sed '/^$/d' | head -n 1 | awk '{print NF-1}') ; if [ \\\$nf -gt 0 ] ; then tmux send-keys -l  ; fi\""
unbind -T root DoubleClick1StatusLeft

# ----------------

# C- same as w/o modifier
bind   -T root C-SecondClick1StatusLeft \
    if-shell -Ft= '#{?#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}},0,1}' \
        "run \"nf=\\\$(tmux capture-pane -p | tac | sed '/^$/d' | head -n 1 | awk '{print NF-1}') ; if [ \\\$nf -gt 0 ] ; then tmux send-keys -l  ; fi\""
# triple is the same as second/double ...
bind   -T root C-TripleClick1StatusLeft \
    if-shell -Ft= '#{?#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}},0,1}' \
        "run \"nf=\\\$(tmux capture-pane -p | tac | sed '/^$/d' | head -n 1 | awk '{print NF-1}') ; if [ \\\$nf -gt 0 ] ; then tmux send-keys -l  ; fi\""
unbind -T root C-DoubleClick1StatusLeft

# ----------------

# M- same as w/o modifier
bind   -T root M-SecondClick1StatusLeft \
    if-shell -Ft= '#{?#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}},0,1}' \
        "run \"nf=\\\$(tmux capture-pane -p | tac | sed '/^$/d' | head -n 1 | awk '{print NF-1}') ; if [ \\\$nf -gt 0 ] ; then tmux send-keys -l  ; fi\""
# triple is the same as second/double ...
bind   -T root M-TripleClick1StatusLeft \
    if-shell -Ft= '#{?#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}},0,1}' \
        "run \"nf=\\\$(tmux capture-pane -p | tac | sed '/^$/d' | head -n 1 | awk '{print NF-1}') ; if [ \\\$nf -gt 0 ] ; then tmux send-keys -l  ; fi\""
unbind -T root M-DoubleClick1StatusLeft

# ----------------

# LEFT - copy-mode ...

# copy selection and cancel copy-mode, but do not paste to cmdline
bind   -T copy-mode-vi SecondClick1StatusLeft \
    if-shell -Ft= "#{selection_present}" \
        "send -X copy-pipe-and-cancel \"myclip ; tmux wait -S pipe\" ; wait pipe" \
        "send -X cancel"
# triple is the same as second/double ...
bind   -T copy-mode-vi TripleClick1StatusLeft \
    if-shell -Ft= "#{selection_present}" \
        "send -X copy-pipe-and-cancel \"myclip ; tmux wait -S pipe\" ; wait pipe" \
        "send -X cancel"
unbind -T copy-mode-vi DoubleClick1StatusLeft

# ----------------

# C- same as w/o modifier
bind   -T copy-mode-vi C-SecondClick1StatusLeft \
    if-shell -Ft= "#{selection_present}" \
        "send -X copy-pipe-and-cancel \"myclip ; tmux wait -S pipe\" ; wait pipe" \
        "send -X cancel"
# triple is the same as second/double ...
bind   -T copy-mode-vi C-TripleClick1StatusLeft \
    if-shell -Ft= "#{selection_present}" \
        "send -X copy-pipe-and-cancel \"myclip ; tmux wait -S pipe\" ; wait pipe" \
        "send -X cancel"
unbind -T copy-mode-vi C-DoubleClick1StatusLeft

# ----------------

# M- same as w/o modifier
bind   -T copy-mode-vi M-SecondClick1StatusLeft \
    if-shell -Ft= "#{selection_present}" \
        "send -X copy-pipe-and-cancel \"myclip ; tmux wait -S pipe\" ; wait pipe" \
        "send -X cancel"
# triple is the same as second/double ...
bind   -T copy-mode-vi M-TripleClick1StatusLeft \
    if-shell -Ft= "#{selection_present}" \
        "send -X copy-pipe-and-cancel \"myclip ; tmux wait -S pipe\" ; wait pipe" \
        "send -X cancel"
unbind -T copy-mode-vi M-DoubleClick1StatusLeft

# ----------------------------------------------

# RIGHT - paste, C-/M- if cmdline not empty send Enter ...

# paste
bind   -T root SecondClick1StatusRight \
    if-shell -Ft= '#{?#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}},0,1}' \
        "run \"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\"<clipboard empty>\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$\""
# triple is the same as second/double ...
bind   -T root TripleClick1StatusRight \
    if-shell -Ft= '#{?#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}},0,1}' \
        "run \"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\"<clipboard empty>\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$\""
unbind -T root DoubleClick1StatusRight

# ----------------

# C- if cmdlline not empty send Enter
bind   -T root C-SecondClick1StatusRight \
    if-shell -Ft= '#{?#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}},0,1}' \
        "run \"nf=$(tmux capture-pane -p | tac | sed '/^$/d' | head -n 1 | awk '{print NF-1}') ; if [ \\\$nf -gt 0 ] ; then tmux send-keys Enter ; fi\""
# triple is the same as second/double ...
bind   -T root C-TripleClick1StatusRight \
    if-shell -Ft= '#{?#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}},0,1}' \
        "run \"nf=$(tmux capture-pane -p | tac | sed '/^$/d' | head -n 1 | awk '{print NF-1}') ; if [ \\\$nf -gt 0 ] ; then tmux send-keys Enter ; fi\""
unbind -T root C-DoubleClick1StatusRight

# ----------------

# M- if cmdlline not empty send Enter
bind   -T root M-SecondClick1StatusRight \
    if-shell -Ft= '#{?#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}},0,1}' \
        "run \"nf=$(tmux capture-pane -p | tac | sed '/^$/d' | head -n 1 | awk '{print NF-1}') ; if [ \\\$nf -gt 0 ] ; then tmux send-keys Enter ; fi\""
# triple is the same as second/double ...
bind   -T root M-TripleClick1StatusRight \
    if-shell -Ft= '#{?#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}},0,1}' \
        "run \"nf=$(tmux capture-pane -p | tac | sed '/^$/d' | head -n 1 | awk '{print NF-1}') ; if [ \\\$nf -gt 0 ] ; then tmux send-keys Enter ; fi\""
unbind -T root M-DoubleClick1StatusRight

# ----------------

# RIGHT - copy-mode ...

# copy selection and cancel copy-mode, but do not paste to cmdline
bind-key -T copy-mode-vi SecondClick1StatusRight \
    if-shell -Ft= "#{selection_present}" \
        "send -X copy-pipe-and-cancel \"myclip ; tmux wait -S pipe\" ; wait pipe" \
        "send -X cancel"
# triple is the same as second/double ...
bind-key -T copy-mode-vi TripleClick1StatusRight \
    if-shell -Ft= "#{selection_present}" \
        "send -X copy-pipe-and-cancel \"myclip ; tmux wait -S pipe\" ; wait pipe" \
        "send -X cancel"
unbind -T   copy-mode-vi DoubleClick1StatusRight

# ----------------

# C- same as above but paste but no Enter
bind-key -T copy-mode-vi C-SecondClick1StatusRight \
    if-shell -Ft= "#{selection_present}" \
        "send -X copy-pipe-no-clear \"myclip ; tmux wait -S pipe\" ; wait pipe ; if -F \"#{||:#{alternate_on},#{mouse_any_flag}}\" \"send -X cancel\" \"send -X cancel ; run \\\"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\\\\\"<clipboard empty>\\\\\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$\\\" \" " \
        "send -X cancel"
# triple is the same as second/double ...
bind-key -T copy-mode-vi C-TripleClick1StatusRight \
    if-shell -Ft= "#{selection_present}" \
        "send -X copy-pipe-no-clear \"myclip ; tmux wait -S pipe\" ; wait pipe ; if -F \"#{||:#{alternate_on},#{mouse_any_flag}}\" \"send -X cancel\" \"send -X cancel ; run \\\"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\\\\\"<clipboard empty>\\\\\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$\\\" \" " \
        "send -X cancel"
unbind -T   copy-mode-vi C-DoubleClick1StatusRight

# ----------------

# M- same as above but paste but no Enter
bind-key -T copy-mode-vi M-SecondClick1StatusRight \
    if-shell -Ft= "#{selection_present}" \
        "send -X copy-pipe-no-clear \"myclip ; tmux wait -S pipe\" ; wait pipe ; if -F \"#{||:#{alternate_on},#{mouse_any_flag}}\" \"send -X cancel\" \"send -X cancel ; run \\\"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\\\\\"<clipboard empty>\\\\\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$\\\" \" " \
        "send -X cancel"
# triple is the same as second/double ...
bind-key -T copy-mode-vi M-TripleClick1StatusRight \
    if-shell -Ft= "#{selection_present}" \
        "send -X copy-pipe-no-clear \"myclip ; tmux wait -S pipe\" ; wait pipe ; if -F \"#{||:#{alternate_on},#{mouse_any_flag}}\" \"send -X cancel\" \"send -X cancel ; run \\\"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\\\\\"<clipboard empty>\\\\\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$\\\" \" " \
        "send -X cancel"
unbind -T   copy-mode-vi M-DoubleClick1StatusRight

# ----------------------------------------------

# CENTER - copy-mode ...

# cancel copy-mode without saving selection without any keypress ...
bind-key -T copy-mode-vi SecondClick1StatusDefault send -X cancel
# triple is the same as second/double ...
bind-key -T copy-mode-vi TripleClick1StatusDefault send -X cancel
unbind   -T copy-mode-vi DoubleClick1StatusDefault

# ----------------------------------------------

# when have Double/Triple click mapped, can be confusing to also have single click mapped ...
# as both will be executed on Double/Triple click ...
#bind-key -T root         MouseUp1StatusRight next
#bind-key -T copy-mode-vi MouseUp1StatusRight next

# history
bind-key -T root WheelUpStatusLeft \
    if-shell -Ft= '#{?#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}},0,1}' \
        "send-keys Up"
bind-key -T root WheelDownStatusLeft \
    if-shell -Ft= '#{?#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}},0,1}' \
        "send-keys Down"

# ----------------

# C-Wheel used for font size by OS/winmgr ...
bind-key -T root M-WheelUpStatusLeft \
    if-shell -Ft= '#{?#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}},0,1}' \
        "send-keys Up"
bind-key -T root M-WheelDownStatusLeft \
    if-shell -Ft= '#{?#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}},0,1}' \
        "send-keys Down"

# ----------------

bind-key -T root WheelUpStatusRight \
    if-shell -Ft= '#{?#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}},0,1}' \
        "send-keys Up"
bind-key -T root WheelDownStatusRight \
    if-shell -Ft= '#{?#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}},0,1}' \
        "send-keys Down"

# ----------------

# C-Wheel used for font size by OS/winmgr ...
bind-key -T root M-WheelUpStatusRight \
    if-shell -Ft= '#{?#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}},0,1}' \
        "send-keys Up"
bind-key -T root M-WheelDownStatusRight \
    if-shell -Ft= '#{?#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}},0,1}' \
        "send-keys Down"

# ==============================================

# seems to mess things up
# unbind-key -T prefix C-z

# C-z to zoom pane, z for fzf ...
bind-key -T prefix C-z resize-pane -Z

# C-s C-a - copy cmd from history
# in copy-mode, do nothing
# in root mode, if alternate do nothing (TODO: or perhaps send C-s C-a); else up arrow for previous cmd
bind-key -T prefix C-a \
    if-shell -Ft= "#{pane_in_mode}" \
        "" \
        "if-shell -Ft= '#{||:#{alternate_on},#{mouse_any_flag}}' \
            \"\" \
            \"send-keys Up\" "

# TODO: prefix C-w to go down through history after prefix C-a ?

# C-s C-x - execute cmd
# in copy-mode, do nothing
# in root mode, if alternate do nothing (TODO: or perhaps send C-s C-x); else if cmdline not empty then Enter
bind-key -T prefix C-x \
    if-shell -Ft= "#{pane_in_mode}" \
        "" \
        "if-shell -Ft= '#{||:#{alternate_on},#{mouse_any_flag}}' \
            \"\" \
            \"run \\\"nf=$(tmux capture-pane -p | tac | sed '/^$/d' | head -n 1 | awk '{print NF-1}') ; if [ \\\\\\\$nf -gt 0 ] ; then tmux send-keys Enter ; fi\\\" \" "

# C-s C-e - clear cmd
# in copy-mode, do nothing
# in root mode, if alternate do nothing (TODO: or perhaps send C-s C-e); else if cmdline not empty then clear it
bind-key -T prefix C-e \
    if-shell -Ft= "#{pane_in_mode}" \
        "" \
        "if-shell -Ft= '#{||:#{alternate_on},#{mouse_any_flag}}' \
            \"\" \
            \"run \\\"nf=$(tmux capture-pane -p | tac | sed '/^$/d' | head -n 1 | awk '{print NF-1}') ; if [ \\\\\\\$nf -gt 0 ] ; then tmux send-keys -l  ; fi\\\" \" "

# Alt-Mouse3 may be mapped to window resize in gnome
# To change it to <Super>:
# gsettings set org.gnome.desktop.wm.preferences resize-with-right-button true
# gsettings set org.gnome.desktop.wm.preferences mouse-button-modifier '<Super>'

# ==============================================

# copy cmdline to clipboard (if not empty)
# TODO: handle cmdline that wraps beyond a single line ...
bind-key -T prefix . \
    if-shell -Ft= "#{pane_in_mode}" \
        "" \
        "run \"cmdline=\\\$(tmux capture-pane -p | tac | sed '/^$/d' | head -n 1 | awk '{for(i=2;i<NF;i++){printf \\\"%s \\\", \\\$i}; if (NF > 1) printf \\\"%s\\\", \\\$NF}') ; if [ -n \\\"\\\$cmdline\\\" ] ; then echo -n \\\$cmdline | myclip ; fi\" "

# Make sure to also unmap terminal (ie terminator)
# Ctrl-PgUp/Dn keys for these to take effect

# many [x]terminals use/map Shift-PgUp/Dn ...
#bind-key -T copy-mode-vi S-PPage halfpage-up
#bind-key -T copy-mode-vi S-NPage halfpage-down

unbind -T prefix PPage
unbind -T prefix NPage

bind   -T copy-mode-vi PPage   send-keys -X page-up
# same for ctrl-b, but half-page scroll
bind   -T copy-mode-vi C-b     send-keys -X halfpage-up

bind   -T copy-mode-vi NPage   if -F "#{selection_present}" "send -X page-down" "send -X page-down-and-cancel"
# same for ctrl-f, but half-page scroll
bind   -T copy-mode-vi C-f     if -F "#{selection_present}" "send -X halfpage-down" "send -X halfpage-down-and-cancel"

bind   -T copy-mode-vi C-PPage send-keys -X halfpage-up
bind   -T copy-mode-vi C-NPage if -F "#{selection_present}" "send -X halfpage-down" "send -X halfpage-down-and-cancel"

bind   -T copy-mode-vi C-S-PPage send-keys -XN 10 scroll-up
bind   -T copy-mode-vi C-S-NPage if -F "#{selection_present}" "send -XN 10 scroll-down" "send -XN 10 scroll-down-and-cancel"

bind   -T copy-mode-vi M-PPage send-keys -XN 2 page-up
bind   -T copy-mode-vi M-NPage if -F "#{selection_present}" "send -XN 2 page-down" "send -XN 2 page-down-and-cancel"

# first press scroll half and enter copy-mode
bind -T root PPage \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'send-keys PPage' \
            'copy-mode ; send -XN 2 cursor-left ; send -X halfpage-up'"

# same for ctrl-b
# but make initial less than that ... 10 seems ok
bind -T root C-b \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'send-keys C-b' \
            'copy-mode ; send -XN 2 cursor-left ; send -XN 10 scroll-up'"

# same for C- but half-page scroll
# first press scroll half that and enter copy-mode
bind -T root C-PPage \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -F '#{m/r:(@v:),#{q:pane_title}}' \
            \"send-keys C-PPage\" \
            \"if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
                \\\"send-keys -N 20 Up\\\" \
                \\\"copy-mode ; send -XN 2 cursor-left ; send -XN 10 scroll-up\\\"\""

bind -T root C-S-PPage \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -F '#{m/r:(@v:),#{q:pane_title}}' \
            \"send-keys C-S-PPage\" \
            \"if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
                \\\"send-keys -N 10 Up\\\" \
                \\\"copy-mode ; send -XN 2 cursor-left ; send -XN 5 scroll-up\\\"\""

# same for M- but 2 page scroll
# first press scroll half that and enter copy-mode
bind -T root M-PPage \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -F '#{m/r:(@v:),#{q:pane_title}}' \
            \"send-keys M-PPage\" \
            \"if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
                \\\"send-keys -N 2 PPage\\\" \
                \\\"copy-mode ; send -XN 2 cursor-left ; send -X page-up\\\"\""

# if not #{alternate_on} dont send NPage key
# data to prevent extraneous chars in output
bind -T root NPage \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'send-keys NPage' \
            ''"

# same for ctrl-f
bind -T root C-f \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'send-keys C-f' \
            ''"

# same for C- but half-page scroll
bind -T root C-NPage \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -F '#{m/r:(@v:),#{q:pane_title}}' \
            \"send-keys C-NPage\" \
            \"if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
                \\\"send-keys -N 20 Down\\\"\""

bind -T root C-S-NPage \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -F '#{m/r:(@v:),#{q:pane_title}}' \
            \"send-keys C-S-NPage\" \
            \"if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
                \\\"send-keys -N 10 Down\\\"\""

# same for M- but 2 page scroll
bind -T root M-NPage \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -F '#{m/r:(@v:),#{q:pane_title}}' \
            \"send-keys M-NPage\" \
            \"if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
                \\\"send-keys -N 2 NPage\\\"\""

# first press does not scroll but just enter copy-mode
bind -T root C-Up \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'send-keys C-Up' \
            'copy-mode ; send -XN 2 cursor-left'"

# if not #{alternate_on} dont send C-Down key
# data to prevent extraneous chars in output
bind -T root C-Down \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'send-keys C-Down'"

# first press does not scroll but just enter copy-mode
bind -T root C-k \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'send-keys C-k' \
            'copy-mode ; send -XN 2 cursor-left'"

# C-S-L/R/U/D - move by 5/10 ...
bind -T root C-S-Up \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}' \
            'send-keys -N 5 Up' \
            'copy-mode ; send -XN 2 cursor-left ; send -XN 5 cursor-up'"

bind -T root C-S-Down \
    if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        'send-keys -N 5 Down'

# TODO: do we map C-S-L/R ?

bind -T root C-S-Left \
    send-keys -N 10 Left

bind -T root C-S-Right \
    send-keys -N 10 Right

bind-key -T copy-mode-vi C-S-Up   \
    send-keys -XN 5 cursor-up

bind-key -T copy-mode-vi C-S-Down \
    if -F "#{selection_active}" \
        "send -XN 5 cursor-down" \
        "send -XN 5 cursor-down-and-cancel"

bind-key -T copy-mode-vi C-S-Left \
    send-keys -XN 10 cursor-left

bind-key -T copy-mode-vi C-S-Right \
    send-keys -XN 10 cursor-right

# ==============================================

# mouse scroll / cut/paste options ...

# instead of clear-selection, use stop-selection
# helps from having extra clicks wipe out selection ...
# This is special in that it allows a single-click to move cursor to mouse x,y
# But it means you cannot extend any selection with the mouse ...
bind   -T copy-mode-vi MouseDown1Pane select-pane \; send -X stop-selection

bind   -T root         MouseDrag1Pane select-pane \; \
    if-shell -F "#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}" \
        "send-keys -M" \
        "copy-mode -M"
bind   -T copy-mode-vi MouseDrag1Pane select-pane \; send -X clear-selection \; send -X begin-selection

# TODO: check if selection is empty before saving with myclip ...
# NOTE: copy to clipboard if its only 1 line, but 'y' or 'q' or 'Esc' are all a single keystroke to exit copy-mode, so whats the difference ?
# BUG: should wait for copy-pipe, but wait pipe hangs if selection is outside range ...

#bind  -T copy-mode-vi MouseDragEnd1Pane select-pane
bind  -T copy-mode-vi MouseDragEnd1Pane select-pane \; send-keys -X copy-pipe-no-clear "tmux load-buffer -b tmpbuf - ; tmux wait -S pipe" \; wait pipe \; run "exst=$(tmux list-buffers | awk '{print $1}' | grep 'tmpbuf:') ; if [ -n \"\$exst\" ] ; then nl=$(tmux show-buffer -b tmpbuf | head -c -1 | wc -l) ; if [ \$nl -lt 1 ] ; then tmux show-buffer -b tmpbuf | myclip ; fi ; tmux delete-buffer -b tmpbuf ; fi"

# TODO: since we do not end copy-mode on scroll down to bottom now, do not copy selection to clipboard here, just stop it - forcing C-c etc. to always cancel copy-mode
# see note below about - scroll-down-and-cancel UNLESS a selection is ACTIVE
# see note below about C- to get back original ability to extend a one-line selection
#bind  -T copy-mode-vi MouseDragEnd1Pane select-pane \; send-keys -X copy-pipe-no-clear "tmux load-buffer -b tmpbuf - ; tmux wait -S pipe" \; wait pipe \; run "nl=$(tmux show-buffer | wc -l) ; if [ \$nl -le 1 ] ; then echo 1 > /dev/shm/tmux#{session_name}.ss ; fi" \; if-shell "test -f \"/dev/shm/tmux#{session_name}.ss\"" "send -X stop-selection ; run \"rm -f /dev/shm/tmux#{session_name}.ss\""

# C- copy dragged selection to clipboard and remain in copy-mode
# NOTE: skip for now as we cannot extend selection via keys etc., so its confusing
# NOTE: make C- work like original so we can extend a one-line drag ...
# TODO: if alt_on or mouse then dont paste, just copy and exit ...
bind -T root         C-MouseDrag1Pane    select-pane \; \
    if-shell -F '#{m/r:(@v:),#{q:pane_title}}' \
        "send-keys -M" \
        "if-shell -F \"#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}\" \
            \"send-keys -M\" \
            \"copy-mode -H -M\""

bind -T copy-mode-vi C-MouseDrag1Pane    select-pane \; send -X begin-selection

# TODO: if we want C-Drag to end copy-mode ...
bind -T copy-mode-vi C-MouseDragEnd1Pane select-pane \; run "sleep 0.30" \; send -X copy-pipe-and-cancel "myclip ; tmux wait -S pipe" \; wait pipe

# TODO: if alt_on or mouse then dont paste, just copy and exit ...
bind -T root         M-MouseDrag1Pane    select-pane \; \
    if-shell -F '#{m/r:(@v:),#{q:pane_title}}' \
        "send-keys -M" \
        "if-shell -F \"#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}\" \
            \"send-keys -M\" \
            \"copy-mode -H -M\""
# never get to root M-MouseDragEnd1Pane because we enter copy-mode at start of drag ...

# M- copy dragged selection to clipboard and cancel copy-mode
bind -T copy-mode-vi M-MouseDrag1Pane    select-pane \; send -X begin-selection

bind -T copy-mode-vi M-MouseDragEnd1Pane select-pane \; \
    run "sleep 0.20" \; send -X copy-pipe-and-cancel "myclip ; tmux wait -S pipe" \; wait pipe \; \
    if -F "#{?#{||:#{alternate_on},#{mouse_any_flag}},0,1}" \
        "run -d 0.1 \"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; fi ; rm -f /dev/shm/tmpbuf\$\$\""

# ==============================================

# enter copy-mode and copy - NOTE: was #{mouse_any_flag}
bind   -T root         SecondClick1Pane \
    if-shell -F "#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}" \
        "send-keys -M" \
        "select-pane ; copy-mode ; send -X clear-selection ; send -l lbvhe ; send -X stop-selection ; send -X copy-pipe-no-clear \"myclip ; tmux wait -S pipe\" ; wait pipe"
# 3-click - instead of select-line or 0v$ we can try to get next larger entity
# NOTE: not sure this can happen since we enter copy-mode on DoubleClick above ...
# NOTE: tmux word-separators are different than vim and this is not much different than lbvhe
bind   -T root         TripleClick1Pane \
    if-shell -F "#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}" \
        "send-keys -M" \
        "select-pane ; copy-mode ; send -X clear-selection ; send -l lBvhE ; send -X stop-selection ; send -X copy-pipe-no-clear \"myclip ; tmux wait -S pipe\" ; wait pipe"
unbind -T root         DoubleClick1Pane

# default select-word does not always stop selelction with a scroll (could also have used send -X select-word for lbvhe)
bind   -T copy-mode-vi SecondClick1Pane \
    select-pane \; send -X clear-selection \; send -l lbvhe \; send -X stop-selection \; send -X copy-pipe-no-clear "myclip ; tmux wait -S pipe" \; wait pipe
# 3-click - instead of select-line or 0v$ we can try to get next larger entity
# NOTE: tmux word-separators are different than vim and this is not much different than lbvhe
bind   -T copy-mode-vi TripleClick1Pane \
    select-pane \; send -X clear-selection \; send -l lBvhE \; send -X stop-selection \; send -X copy-pipe-no-clear "myclip ; tmux wait -S pipe" \; wait pipe
unbind -T copy-mode-vi DoubleClick1Pane

# ----------------

# NOTE: cannot seem to ignore 2Btn event ...
bind   -T root MouseDown2Pane if-shell -F -t = "#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}" " select-pane -t=; send-keys -M " " display-menu -t= -xM -yM -T '#[align=centre]#{pane_index} (#{pane_id})'  '#{?#{m/r:(copy|view)-mode,#{pane_mode}},Go To Top,}' '<' {send -X history-top} '#{?#{m/r:(copy|view)-mode,#{pane_mode}},Go To Bottom,}' '>' {send -X history-bottom} '' '#{?mouse_word,Search For #[underscore]#{=/9/...:mouse_word},}' 'C-r' {if -F '#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}' 'copy-mode -t='; send -Xt= search-backward \"#{q:mouse_word}\"} '#{?mouse_word,Type #[underscore]#{=/9/...:mouse_word},}' 'C-y' {copy-mode -q; send-keys -l -- \"#{q:mouse_word}\"} '#{?mouse_word,Copy #[underscore]#{=/9/...:mouse_word},}' 'c' {copy-mode -q; set-buffer -- \"#{q:mouse_word}\"} '#{?mouse_line,Copy Line,}' 'l' {copy-mode -q; set-buffer -- \"#{q:mouse_line}\"} '' 'Horizontal Split' 'h' {split-window -h} 'Vertical Split' 'v' {split-window -v} '' '#{?#{>:#{window_panes},1},,-}Swap Up' 'u' {swap-pane -U} '#{?#{>:#{window_panes},1},,-}Swap Down' 'd' {swap-pane -D} '#{?pane_marked_set,,-}Swap Marked' 's' {swap-pane} '' 'Kill' 'X' {kill-pane} 'Respawn' 'R' {respawn-pane -k} '#{?pane_marked,Unmark,Mark}' 'm' {select-pane -m} '#{?#{>:#{window_panes},1},,-}#{?window_zoomed_flag,Unzoom,Zoom}' 'z' {resize-pane -Z} "

unbind -T root SecondClick2Pane
unbind -T root TripleClick2Pane
unbind -T root DoubleClick2Pane

# C-Btn2 used by some terminals (urxvt) ...
unbind -T root C-MouseDown2Pane
unbind -T root C-SecondClick2Pane
unbind -T root C-TripleClick2Pane
unbind -T root C-DoubleClick2Pane

# NOTE: A-Btn2 available ...
unbind -T root M-MouseDown2Pane
unbind -T root M-SecondClick2Pane
unbind -T root M-TripleClick2Pane
unbind -T root M-DoubleClick2Pane

# ----------------

# NOTE: if we can do a mouse menu in vi and can know we are in vi reliably locally and remote then dont put up a menu
#       if not and we can still know we are in vi reliably then put up a Copy/Paste menu for vi and use vi cmds
#       else put up a general-purpose Paste menu
#
#       local cmd check:
#       #{m/r:(vi|vim),#{pane_current_command}}
#
#       manual check:
#       if-shell "vmd=\$(tmux show-environment -g TMUX_VI_MODE 2>/dev/null | awk -F= '{print \$2}') ; if [ \"\$vmd\" != \"1\" ] ; then exit 1 ; else exit 0 ; fi" \
#           "if-shell -Ft= '#{alternate_on}' \
#
#       vi sets title (works remotely also) ...
#       See https://sunaku.github.io/tmux-select-pane.html for documentation.
#       set title titlestring=@v:
#       if &term =~ '^screen' && !has('nvim') | exe "set t_ts=\e]2; t_fs=\7" | endif
#       #{m/r:(@v:),#{q:pane_title}}

# for vi - set Copy/Cut/Paste + other general purpose Paste menu -
bind   -T root         MouseDown3Pane select-pane -t = \; \
    if-shell -F '#{m/r:(@v:),#{q:pane_title}}' \
        "display-menu -x M -y M \
            ' Copy '  '' 'send-keys M-7' '' \
            ' Cut '   '' 'send-keys M-9' '' \
            ' Paste ' '' 'send-keys M-8' '' \
            ' Clear ' '' 'send-keys C-[' " \
        "display-menu -x M -y M \
            ' Paste ' '' 'run \"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\"<clipboard empty>\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$\"'"

# general purpose Paste only menu -
#bind   -T root         MouseDown3Pane select-pane -t = \; \
#    display-menu -x M -y M ' Paste ' '' 'run "xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\"<clipboard empty>\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$"'

unbind -T root         SecondClick3Pane
unbind -T root         TripleClick3Pane
unbind -T root         DoubleClick3Pane

# ----------------

# cool if we could use -x#{selection_end_x{} -y #{slection_end_y} ...
bind   -T copy-mode-vi MouseDown3Pane select-pane -t = \; if-shell -F "#{selection_present}" "display-menu -x M -y M ' Copy+Q ' '' 'send-keys -X copy-pipe-and-cancel \"myclip ; tmux wait -S pipe\" ; wait pipe' '' ' Copy+P ' '' 'send-keys -X copy-pipe-and-cancel \"myclip ; tmux wait -S pipe\"  ; wait pipe ; run \"xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \\\"<clipboard empty>\\\" ; fi ; rm -f /dev/shm/tmpbuf\$\$\"' '' ' Copy ' '' 'send-keys -X copy-pipe-no-clear \"myclip ; tmux wait -S pipe\" ; wait pipe' '' ' Clear ' '' 'delete-buffer -b append001 ; send -X clear-selection' '' ' Append ' '' 'send-keys -X copy-pipe-no-clear \"myclip ; tmux wait -S pipe\" ; wait pipe ; run \"tmux save-buffer -b append001 /dev/shm/tmux.buf ; xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc | tmux load-buffer -b tmpbuf - && tmux save-buffer -a /dev/shm/tmux.buf ; cat /dev/shm/tmux.buf | myclip ; tmux delete-buffer -b tmpbuf ; cat /dev/shm/tmux.buf | tmux load-buffer -b append001 - ; rm -f /dev/shm/tmux.buf\"' '' ' ClearA ' '' 'delete-buffer -b append001' '' ' Quit ' '' 'send -X cancel'" "display-menu -t= -xM -yM ' Quit ' '' 'send -X cancel'"
unbind -T copy-mode-vi SecondClick3Pane
unbind -T copy-mode-vi TripleClick3Pane
unbind -T copy-mode-vi DoubleClick3Pane

# ----------------

# C-Btn3 used by some terminals (urxvt) ...
# try to map it here and if its high-jacked by parent terminal then so be it ...

#unbind -T root         C-MouseDown3Pane
#unbind -T root         C-SecondClick3Pane
#unbind -T root         C-TripleClick3Pane
#unbind -T root         C-DoubleClick3Pane

#unbind -T copy-mode-vi C-MouseDown3Pane
#unbind -T copy-mode-vi C-SecondClick3Pane
#unbind -T copy-mode-vi C-TripleClick3Pane
#unbind -T copy-mode-vi C-DoubleClick3Pane

# C-Btn3 root paste (same as A-) ...
bind   -T root         C-MouseDown3Pane   select-pane -t = \; \
    if-shell -F "#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}" \
        'send-keys -M' \
        'run "xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \"<clipboard empty>\" ; fi ; rm -f /dev/shm/tmpbuf\$\$"'
bind   -T root         C-SecondClick3Pane select-pane -t = \; \
    if-shell -F "#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}" \
        'send-keys -M' \
        'run "xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \"<clipboard empty>\" ; fi ; rm -f /dev/shm/tmpbuf\$\$"'
unbind -T root         C-TripleClick3Pane
unbind -T root         C-DoubleClick3Pane

# C-Btn3 copy-mode if selection present then copy and cancel ...
bind   -T copy-mode-vi C-MouseDown3Pane   select-pane -t = \; \
    if-shell -F '#{selection_present}' \
        "send-keys -X copy-pipe-and-cancel \"myclip ; tmux wait -S pipe\" ; wait pipe" \
        "send -X cancel"
bind   -T copy-mode-vi C-SecondClick3Pane select-pane -t = \; \
    if-shell -F '#{selection_present}' \
        "send-keys -X copy-pipe-and-cancel \"myclip ; tmux wait -S pipe\" ; wait pipe" \
        "send -X cancel"
unbind -T copy-mode-vi C-TripleClick3Pane
unbind -T copy-mode-vi C-DoubleClick3Pane

# ----------------

# A-Btn3 always paste ...
bind   -T root         M-MouseDown3Pane   select-pane -t = \; \
    if-shell -F "#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}" \
        'send-keys -M' \
        'run "xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \"<clipboard empty>\" ; fi ; rm -f /dev/shm/tmpbuf\$\$"'
bind   -T root         M-SecondClick3Pane select-pane -t = \; \
    if-shell -F "#{||:#{alternate_on},#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}}" \
        'send-keys -M' \
        'run "xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \"<clipboard empty>\" ; fi ; rm -f /dev/shm/tmpbuf\$\$"'
unbind -T root         M-TripleClick3Pane
unbind -T root         M-DoubleClick3Pane

# copy-mode A-Btn3 cancel copy-mode and paste ...
bind   -T copy-mode-vi M-MouseDown3Pane   select-pane -t = \; \
    if-shell -F '#{selection_present}' \
        'send-keys -X copy-pipe-and-cancel "myclip ; tmux wait -S pipe" ; wait pipe ; run "xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \"<clipboard empty>\" ; fi ; rm -f /dev/shm/tmpbuf\$\$"' \
        'send -X cancel'
bind   -T copy-mode-vi M-SecondClick3Pane select-pane -t = \; \
    if-shell -F '#{selection_present}' \
        'send-keys -X copy-pipe-and-cancel "myclip ; tmux wait -S pipe" ; wait pipe ; run "xsel -o -b --rmlastnl --sc /dev/shm/tmux#{session_name}.spc > /dev/shm/tmpbuf\$\$ ; if [ -s /dev/shm/tmpbuf\$\$ ] ; then tmux load-buffer /dev/shm/tmpbuf\$\$ ; tmux paste-buffer -dp ; else tmux display-message \"<clipboard empty>\" ; fi ; rm -f /dev/shm/tmpbuf\$\$"' \
        'send -X cancel'
unbind -T copy-mode-vi M-TripleClick3Pane
unbind -T copy-mode-vi M-DoubleClick3Pane

# ----------------

bind -T copy-mode-vi WheelUpPane \
    select-pane \; send-keys -XN 10 scroll-up
#   select-pane \; send -X stop-selection \; send-keys -XN 10 scroll-up

# Alt-Wheel for a faster scroll
bind -T copy-mode-vi M-WheelUpPane \
    select-pane \; send-keys -XN 48 scroll-up
#   select-pane \; send -X stop-selection \; send-keys -XN 48 scroll-up

# NOTE: no C-WheelUp - often that is font zoom etc. ...

bind -T root         WheelUpPane \
	if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}' \
			\"send-keys -M\" \
            \"if-shell -Ft= '#{alternate_on}' \
				'send-keys -N 10 Up' \
				'copy-mode ; send -XN 2 cursor-left ; send -XN 5 scroll-up'\""

bind -T root         M-WheelUpPane \
	if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}' \
			\"send-keys -M\" \
            \"if-shell -Ft= '#{alternate_on}' \
				'send-keys -N 48 Up' \
				'copy-mode ; send -XN 2 cursor-left ; send -XN 24 scroll-up'\""

# ----------------

bind -T copy-mode-vi WheelDownPane select-pane \; \
    if -F "#{selection_active}" "send -XN 10 scroll-down" "send -XN 10 scroll-down-and-cancel"

# Alt-Wheel for a faster scroll
bind -T copy-mode-vi M-WheelDownPane select-pane \; \
    if -F "#{selection_active}" "send -XN 48 scroll-down" "send -XN 48 scroll-down-and-cancel"

# NOTE: no C-WheelDown - often that is font zoom etc. ...

# if not #{alternate_on} dont send Down key
# data to prevent extraneous chars in output
bind -T root         WheelDownPane \
	if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}' \
			\"send-keys -M\" \
            \"if-shell -Ft= '#{alternate_on}' \
				'send-keys -N 10 Down' \
				''\""

bind -T root         M-WheelDownPane \
	if-shell -Ft= "#{?pane_active,0,1}" "select-pane -t=" \
        "if-shell -Ft= '#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}' \
			\"send-keys -M\" \
            \"if-shell -Ft= '#{alternate_on}' \
				'send-keys -N 48 Down' \
				''\""

# ==============================================

